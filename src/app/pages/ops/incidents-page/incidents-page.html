<div class="flex flex-col gap-6">
  <header class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="space-y-1.5">
      <h1 class="text-3xl font-extrabold tracking-tight">Incidentes</h1>
      <p class="text-sm text-muted-color-emphasis">
        Revisa los incidentes por resolver y los que ya fueron atendidos.
      </p>
    </div>
    <div class="flex items-center gap-3">
      <a
        class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-sm font-medium text-slate-600 transition hover:border-slate-400 hover:text-slate-700"
        routerLink="/ops/create-incident"
        type="button"
      >
        <span class="pi pi-plus"></span>
        Nuevo incidente
      </a>
      <button
        class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-sm font-medium text-slate-600 transition hover:border-slate-400 hover:text-slate-700 disabled:opacity-50"
        type="button"
        (click)="refreshCurrent()"
        [disabled]="loading()"
      >
        <span class="pi pi-refresh"></span>
        Actualizar
      </button>
    </div>
  </header>

  <nav class="flex flex-wrap items-center gap-2">
    @for (option of tabOptions; track option.key) {
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2"
      [class.bg-rose-100]="currentTab() === option.key"
      [class.text-rose-700]="currentTab() === option.key"
      [class.border-rose-200]="currentTab() === option.key"
      [class.bg-slate-100]="currentTab() !== option.key"
      [class.text-slate-600]="currentTab() !== option.key"
      [class.border-slate-200]="true"
      [disabled]="loading() && currentTab() === option.key"
      (click)="selectTab(option.key)"
    >
      <ng-icon [name]="option.icon" class="h-4 w-4"></ng-icon>
      {{ option.label }}
    </button>
    }
  </nav>

  <p class="text-sm text-slate-500">
    @for (option of tabOptions; track option.key) { @if (currentTab() === option.key) {
    {{ option.description }}
    } }
  </p>

  @if (errorMessage()) {
  <div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
    {{ errorMessage() }}
  </div>
  } @if (loading() && !incidents().length) {
  <div class="rounded-xl border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-700">
    Cargando incidentes...
  </div>
  } @if (!loading() && !errorMessage() && !incidents().length) {
  <div
    class="flex flex-col items-center justify-center rounded-xl border border-slate-200 bg-slate-50 px-6 py-10 text-center text-slate-500"
  >
    <ng-icon name="tablerExclamationCircle" class="h-10 w-10 text-slate-400"></ng-icon>
    <h2 class="mt-3 text-lg font-medium text-slate-700">Nada por aquí</h2>
    <p class="text-sm">Cuando se registren incidentes los verás listados en esta vista.</p>
  </div>
  } @if (incidents().length) {
  <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
          <tr>
            <th class="px-6 py-3 text-left">Incidente</th>
            <th class="px-6 py-3 text-left">Tipo</th>
            <th class="px-6 py-3 text-left">Reporte</th>
            <th class="px-6 py-3 text-left">Estado</th>
            <th class="px-6 py-3 text-left">Negocio / Destinatario</th>
            <th class="px-6 py-3 text-left">Descripción</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 text-sm text-slate-700">
          @for (incident of incidents(); track incident.incident_id) {
          <tr class="hover:bg-slate-50/75">
            <td class="px-6 py-4 align-top">
              <div class="font-semibold text-slate-800">{{ incident.guide_number }}</div>
              <div class="text-xs text-slate-500">ID guía: {{ incident.guide_id }}</div>
            </td>
            <td class="px-6 py-4 align-top">
              <div class="font-medium text-slate-800">{{ incident.incident_type_name }}</div>
              <div class="text-xs text-slate-500">
                Requiere retorno: {{ incident.requires_return ? 'Sí' : 'No' }}
              </div>
            </td>
            <td class="px-6 py-4 align-top">
              <div class="font-medium">{{ incident.reported_by_name }}</div>
              <div class="text-xs text-slate-500">{{ incident.reported_by_role }}</div>
              <div class="text-xs text-slate-400">
                {{ incident.created_at | date : 'dd/MM/yyyy HH:mm' }}
              </div>
            </td>
            <td class="px-6 py-4 align-top">
              <span
                class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium"
                [class.bg-emerald-100]="incident.resolved"
                [class.text-emerald-700]="incident.resolved"
                [class.bg-amber-100]="!incident.resolved"
                [class.text-amber-700]="!incident.resolved"
              >
                {{ incident.resolved ? 'Resuelto' : 'Pendiente' }}
              </span>
              @if (incident.resolved_at) {
              <div class="mt-1 text-xs text-slate-500">
                {{ incident.resolved_at | date : 'dd/MM/yyyy HH:mm' }}
              </div>
              } @if (incident.resolution) {
              <div class="mt-1 text-xs text-slate-500">
                Por: {{ incident.resolved_by_name || '—' }}
              </div>
              }
            </td>
            <td class="px-6 py-4 align-top">
              <div class="font-medium">{{ incident.business_name }}</div>
              <div class="text-xs text-slate-500">{{ incident.recipient_name }}</div>
              <div class="text-xs text-slate-400">{{ incident.recipient_address }}</div>
            </td>
            <td class="px-6 py-4 align-top">
              <p class="text-sm text-slate-700">{{ incident.description }}</p>
              @if (incident.resolution) {
              <p class="mt-2 rounded-lg bg-emerald-50 px-3 py-2 text-xs text-emerald-700">
                {{ incident.resolution }}
              </p>
              }
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <div
      class="flex flex-col items-center justify-between gap-4 border-t border-slate-200 px-6 py-4 text-sm text-slate-600 md:flex-row"
    >
      <span>{{ pageRangeLabel() }}</span>
      <div class="flex items-center gap-3">
        <label class="flex items-center gap-2">
          Tamaño
          <select
            class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm focus:border-rose-400 focus:outline-none focus:ring-1 focus:ring-rose-300"
            [value]="pageSize()"
            (change)="onPageSizeChange($event)"
            [disabled]="loading()"
          >
            @for (size of pageSizeOptions; track size) {
            <option [value]="size">{{ size }}</option>
            }
          </select>
        </label>
        <div class="flex items-center gap-2">
          <button
            type="button"
            class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-sm transition hover:border-slate-300 disabled:opacity-50"
            (click)="goToPreviousPage()"
            [disabled]="isFirstPage() || loading()"
          >
            <span class="pi pi-chevron-left"></span>
            <span class="ml-1 hidden sm:inline">Anterior</span>
          </button>
          <span>Página {{ pageIndex() + 1 }} de {{ totalPages() }}</span>
          <button
            type="button"
            class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-sm transition hover:border-slate-300 disabled:opacity-50"
            (click)="goToNextPage()"
            [disabled]="isLastPage() || loading()"
          >
            <span class="pi pi-chevron-right"></span>
            <span class="ml-1 hidden sm:inline">Siguiente</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  }
</div>
