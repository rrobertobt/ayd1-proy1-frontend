<section class="max-w-5xl mx-auto">
  <header class="mb-6">
    <h1 class="text-3xl font-extrabold tracking-tight">
      {{ isEdit ? 'Editar empleado' : 'Nuevo empleado' }}
    </h1>
    <p class="text-sm text-slate-500 mt-1">Datos personales, rol y seguridad de acceso.</p>
  </header>

  <div *ngIf="errorMsg" class="mb-4 p-3 rounded border border-red-200 bg-red-50 text-red-700 text-sm">
    {{ errorMsg }}
  </div>

  <div *ngIf="loading" class="rounded-2xl border bg-white shadow-sm p-6">
    <div class="animate-pulse space-y-3">
      <div class="h-4 bg-slate-200 rounded w-1/3"></div>
      <div class="h-28 bg-slate-200 rounded"></div>
    </div>
  </div>

  <form *ngIf="!loading" [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
    <div class="rounded-2xl border bg-white shadow-sm relative overflow-hidden">
      <!-- overlay stays, but under the actionable elements -->
      <div *ngIf="isReactivateMode" class="absolute inset-0 bg-white/60 backdrop-blur-[2px] z-10 pointer-events-none"></div>

      <div class="p-6 grid gap-6 md:grid-cols-2 relative">
        <!-- Banner (above the overlay) -->
        <div *ngIf="isReactivateMode" class="md:col-span-2 -mt-2 relative z-20">
          <div class="flex items-start justify-between p-3 rounded-lg border border-amber-200 bg-amber-50">
            <div class="text-sm text-amber-800">
              Este usuario está <span class="font-medium">desactivado</span>. Actívalo para poder editarlo.
            </div>
            <button
              type="button"
              class="px-3 py-2 rounded-md bg-amber-600 text-white text-sm hover:bg-amber-700 disabled:opacity-50"
              (click)="reactivate()"
              [disabled]="saving"
            >
              {{ saving ? 'Activando…' : 'Activar usuario' }}
            </button>
          </div>
        </div>

        <!-- Email -->
        <div class="grid gap-2">
          <label class="text-sm font-medium">Email<span class="text-red-500">*</span></label>
          <input
            class="w-full rounded-md border px-3 py-2.5 placeholder:text-slate-600"
            formControlName="email"
            placeholder="empleado@empresa.com"
          />
          <span class="text-xs text-red-600" *ngIf="submitted && form.controls['email'].invalid">Email requerido</span>
        </div>

        <!-- Role -->
        <div class="grid gap-2">
          <label class="text-sm font-medium">Rol<span class="text-red-500">*</span></label>
          <select class="w-full rounded-md border px-3 py-2.5" formControlName="role_id">
            <option *ngFor="let r of roles" [value]="r.role_id">{{ r.role_name }}</option>
          </select>
        </div>

        <!-- Names -->
        <div class="grid gap-2">
          <label class="text-sm font-medium">Nombre(s)<span class="text-red-500">*</span></label>
          <input class="w-full rounded-md border px-3 py-2.5 placeholder:text-slate-600"
                 formControlName="first_name" placeholder="Ana" />
          <span class="text-xs text-red-600" *ngIf="submitted && form.controls['first_name'].invalid">Requerido</span>
        </div>

        <div class="grid gap-2">
          <label class="text-sm font-medium">Apellidos<span class="text-red-500">*</span></label>
          <input class="w-full rounded-md border px-3 py-2.5 placeholder:text-slate-600"
                 formControlName="last_name" placeholder="Gómez" />
          <span class="text-xs text-red-600" *ngIf="submitted && form.controls['last_name'].invalid">Requerido</span>
        </div>

        <!-- Phone / ID -->
        <div class="grid gap-2">
          <label class="text-sm font-medium">Teléfono</label>
          <input class="w-full rounded-md border px-3 py-2.5 placeholder:text-slate-600"
                 formControlName="phone" placeholder="+502 2222-0000" />
        </div>

        <div class="grid gap-2">
          <label class="text-sm font-medium">Documento de identidad</label>
          <input class="w-full rounded-md border px-3 py-2.5 placeholder:text-slate-600"
                 formControlName="national_id" placeholder="DPI / NIT personal" />
        </div>

        <!-- Address -->
        <div class="grid gap-2 md:col-span-2">
          <label class="text-sm font-medium">Dirección</label>
          <textarea class="w-full rounded-md border px-3 py-2.5 min-h-[88px] placeholder:text-slate-600"
                    formControlName="address" placeholder="Dirección completa"></textarea>
        </div>

        <!-- Security & status (above the overlay and active enabled) -->
        <div class="md:col-span-2 flex flex-wrap items-center gap-6 relative z-20">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" formControlName="two_factor_enabled" class="h-4 w-4" />
            <span class="text-sm">Habilitar 2FA</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" formControlName="active" class="h-4 w-4" />
            <span class="text-sm">Activo</span>
          </label>
        </div>

        <!-- Temp password (create only) -->
        <div class="grid gap-2 md:col-span-2" *ngIf="!isEdit">
          <label class="text-sm font-medium">Contraseña temporal<span class="text-red-500">*</span></label>
          <input class="w-full rounded-md border px-3 py-2.5 placeholder:text-slate-600"
                 formControlName="temporary_password" placeholder="Proporciona una contraseña temporal" />
          <span class="text-xs text-red-600" *ngIf="submitted && form.controls['temporary_password'].invalid">Requerida</span>
        </div>
      </div>
    </div>

    <div *ngIf="saveError" class="p-3 rounded border border-red-200 bg-red-50 text-red-700 text-sm">
      {{ saveError }}
    </div>

    <div class="flex flex-col sm:flex-row gap-3 justify-end">
      <button class="px-5 py-2.5 rounded-md bg-indigo-600 text-white font-medium"
              [disabled]="saving || (submitted && form.invalid)">
        {{ saving ? 'Guardando…' : (isEdit ? 'Guardar cambios' : 'Crear empleado') }}
      </button>
      <button type="button" class="px-5 py-2.5 rounded-md border font-medium" (click)="back()">Cancelar</button>
    </div>
  </form>
</section>
