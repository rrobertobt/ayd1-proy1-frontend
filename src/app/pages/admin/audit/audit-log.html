<section class="max-w-6xl mx-auto">
  <header class="mb-4">
    <h1 class="text-xl font-bold">Bitácora del sistema</h1>
    <p class="text-sm text-slate-500">Filtros opcionales por tabla, usuario y fecha.</p>
  </header>

  <form [formGroup]="form" class="rounded border bg-white p-4 grid gap-3 md:grid-cols-4 mb-4">
    <div class="grid gap-1">
      <label class="text-xs font-medium">Tabla</label>
      <select formControlName="tableName" class="rounded border px-2 py-2">
        <option value="">Todas</option>
        <option *ngFor="let t of tableNames" [value]="t">{{ t }}</option>
      </select>
    </div>
    <div class="grid gap-1">
      <label class="text-xs font-medium">Usuario (ID)</label>
      <input formControlName="userId" type="number" class="rounded border px-2 py-2" placeholder="e.g. 7" />
    </div>
    <div class="grid gap-1">
      <label class="text-xs font-medium">Desde</label>
      <input formControlName="startDate" type="date" class="rounded border px-2 py-2" />
    </div>
    <div class="grid gap-1">
      <label class="text-xs font-medium">Hasta</label>
      <input formControlName="endDate" type="date" class="rounded border px-2 py-2" />
    </div>

    <div class="md:col-span-4 flex gap-2 justify-end">
      <button type="button" class="px-3 py-2 rounded border" (click)="clear()">Limpiar</button>
      <button type="button" class="px-3 py-2 rounded bg-indigo-600 text-white" (click)="fetch()">Buscar</button>
    </div>
  </form>

  <div class="rounded border bg-white" *ngIf="loading">
    <div class="p-4">
      <div class="animate-pulse space-y-3">
        <div class="h-4 bg-slate-200 rounded w-1/3"></div>
        <div class="h-24 bg-slate-200 rounded"></div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && errorMsg" class="p-3 rounded border border-red-200 bg-red-50 text-red-700 text-sm">
    {{ errorMsg }}
  </div>

  <div class="rounded border bg-white overflow-x-auto" *ngIf="!loading && !errorMsg">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-100 text-slate-600">
        <tr>
          <th class="text-left p-3">Fecha</th>
          <th class="text-left p-3">Tabla</th>
          <th class="text-left p-3">Operación</th>
          <th class="text-left p-3">Registro</th>
          <th class="text-left p-3">Usuario</th>
          <th class="text-left p-3">IP</th>
          <th class="text-left p-3">Datos</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of items" class="border-t">
          <td class="p-3 whitespace-nowrap">{{ r.created_at }}</td>
          <td class="p-3">{{ r.table_name }}</td>
          <td class="p-3">{{ opName(r.operation_type_id) }}</td>
          <td class="p-3">#{{ r.record_id ?? '-' }}</td>
          <td class="p-3">{{ r.user_id ?? '-' }}</td>
          <td class="p-3">{{ r.ip_address ?? '-' }}</td>
          <td class="p-3">
            <details>
              <summary class="cursor-pointer text-indigo-600">Ver</summary>
              <div class="grid md:grid-cols-2 gap-3 mt-2">
                <div>
                  <div class="text-xs font-medium text-slate-600 mb-1">Old</div>
                  <pre class="text-xs bg-slate-50 rounded p-2 overflow-auto max-h-64">{{ r.old_data | json }}</pre>
                </div>
                <div>
                  <div class="text-xs font-medium text-slate-600 mb-1">New</div>
                  <pre class="text-xs bg-slate-50 rounded p-2 overflow-auto max-h-64">{{ r.new_data | json }}</pre>
                </div>
              </div>
            </details>
          </td>
        </tr>
        <tr *ngIf="items.length === 0">
          <td colspan="7" class="p-6 text-center text-slate-500">Sin registros</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
